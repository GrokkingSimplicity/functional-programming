# 신뢰할 수 없는 코드를 쓰면서 불변성 지키기

- 카피 온 라이트 원칙을 지키면서 안전하게 함수를 사용할 수 있는 다른 원칙은 방어적 복사, 데이터를 바꾸는 코드와 데이터를 주고받는다.
- 방어적 복사가 동작하는 방식은 들어오고 나가는 데이터의 복사본을 만드는것, 안전지대에 불변성을 유지하고, 바뀔수도 있는 데이터가 안전지대로 들어오지 못하도록 하는것

### 방어적 복사의 규칙

- 데이터가 안전한 코드에서 나갈 때 복사하기
- 안전한 코드로 데이터가 들어올 때 복사하기

### 카피 온 라이트

- 통제할 수 있는 데이터를 바꿀 때 사용
- 안전지대 어디에서나 사용, 카피 온 라이트는 불변성을 가진 안전지대를 만든다.
- 방식은 얕은 복사로 상대적으로 비용이 적게 든다.
- 바꿀 데이터의 얕은 복사를 만들고, 복사본을 변경하고, 복사본을 리턴한다.

### 방어적 복사

- 신뢰할 수 없는 코드와 데이터를 주고받아야할 떄 방어적 복사를 사용한다.
- 안전지대의 경계에서 데이터가 오고갈 때 방어적 복사를 사용한다.
- 깊은 복사를 사용하며 상대적으로 비용이 많이 든다.
- 안전지대로 들어오는 데이터에 깊은 복사를 만들고, 안전지대에서 나가는 데이터에 깊은 복사를 만든다.

# 계층형 설계

- 소프트웨어 설계란 코드를 만들고, 테스트하고, 유지보수하기 쉬운 프로그래밍 방법을 선택하기 위해 미적 감각을 사용하는 것

## 계층형 설계란?

- 소프트웨어를 계층으로 구성하는 기술로, 계층에 있는 함수는 바로 아래 계층에 있는 함수를 이용해 정의한다.

### 계층형 설계 패턴

1. 직접 구현
2. 추상화 벽
3. 작은 인터페이스
4. 편리한 계층

### 직접 구현 패턴

- 직접 구현한 코드는 한 단계의 구체화 수준에 관한 문제만 해결한다.
- 계층형 설계는 특정 구체화 단계에 집중할 수 있게 도와준다.
- 호출 그래프는 구체화 단계에 대한 풍부한 단서를 보여준다.
- 함수를 추출하면 더 일반적인 함수로 만들 수 있다.
- 일반적인 함수가 많을수록 재사용하기 좋다.
- 복잡성을 감추지 않는다.
